<!DOCTYPE html>
<html lang="kr">
<head>
  <meta charset="UTF-8">
  <title>HOME</title>
  <link rel="stylesheet" href="../styles.css">
</head>

<body id=frame>
  <h1>사용자 추가</h1>
  유의사항: 다중 알레르기가 있다면 같은 방식으로 여러 번 진행해주세요.<br><br>
  <form id="dataForm">
    <label for="name">이름: </label>
    <input type="text" id="name" name="name" required autocomplete="off"><br>
    <label for="allergy">알레르기 식품: </label>
    <select id="allergy" name="allergy" required>
      <option value="없음">없음</option>
      <option value="난류">난류</option>
      <option value="우유">우유</option>
      <option value="메밀">메밀</option>
      <option value="땅콩">땅콩</option>
      <option value="대두">대두</option>
      <option value="밀">밀</option>
      <option value="고등어">고등어</option>
      <option value="게">게</option>
      <option value="새우">새우</option>
      <option value="돼지고기">돼지고기</option>
      <option value="복숭아">복숭아</option>
      <option value="토마토">토마토</option>
      <option value="아황산류">아황산류</option>
      <option value="호두">호두</option>
      <option value="닭고기">닭고기</option>
      <option value="쇠고기">쇠고기</option>
      <option value="오징어">오징어</option>
      <option value="조개류">조개류(굴, 전복, 홍합 포함)</option>
      <option value="잣">잣</option>
    </select>
    <pre><button type="submit">저장</button></pre>
  </form>
  <h1>사용자 삭제</h1>
  <ul id="dataList"></ul>
  
  <script>
    const bridge = new WebOSServiceBridge();

    window.onload = function() {
      putKind();
      putPermissions();
    }

    //데이터베이스 디자이닝
    function putKind() {
      let url = 'luna://com.webos.service.db/putKind';
      bridge.onservicecallback = (msg) => {console.log(msg)};
      let params = {
        "id": "app.sofi.db.user:1",
        "owner": "app.sofi.db.user",
        "indexes": [
          {
            "name": "index0",
            "props": [
              {"name": "name"}
            ]
          },
          {
            "name": "index1",
            "props": [
              {"name": "allergy"}
            ]
          },
          {
            "name": "index2",
            "props": [
              {"name": "id"}
            ]
          }
        ]
      };
      bridge.call(url, JSON.stringify(params));
    }

    //데이터베이스 권한 설정
    function putPermissions() {
      let url = 'luna://com.webos.service.db/putPermissions';
      bridge.onservicecallback = (msg) => {console.log(msg)};
      let params = {
        "permissions": [
          {
            "operations":{
              "read": "allow",
              "create": "allow",
              "update": "allow",
              "delete": "allow"
            },
            "object": "app.sofi.db.user:1",
            "type": "db.kind",
            "caller": "app.sofi.db.user"
          }
        ]
      };
      bridge.call(url, JSON.stringify(params));
    }
    
    //데이터 화면에 출력
    function showData(res) {
      let user = JSON.parse(res).results;
      alert("출력 되냐?");
      let text = '';

      for (let i in results) {
        text.innerHTML =`
          이름: ${user[i].name}, 알러지: ${user[i].allergy}
          <button onclick="deleteUser(${user[i].id})">삭제</button>`;
        document.getElementById('dataList').appendChild(text);
      }
    }

    //입력한 값을 데이터베이스에 저장
    document.getElementById('dataForm').addEventListener('submit', function(event) {
      let url = 'luna://com.webos.service.db/put';
      alert("제출 진입");
      bridge.onservicecallback = showData;

      let params = {
        "objects": [
          {
            "_kind": kindID,
            "name": document.getElementById('name').value,
            "allergy": document.getElementById('allergy').value,
            "number": 0
          }
        ]
      };
      alert("데이터 저장되기 직전!");
      bridge.call(url, JSON.stringify(params));
    });
  </script>
</body>
</html>